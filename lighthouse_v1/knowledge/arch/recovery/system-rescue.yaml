start: rescue_entry

nodes:
  rescue_entry:
    question: "Why are you in a rescue environment?"
    options:
      b: "System does not boot"
      k: "Kernel panic"
      f: "Filesystem issues"
      e: "Emergency shell or initramfs prompt"
    next:
      b: no_boot
      k: panic
      f: filesystem
      e: emergency_shell

  # --- SYSTEM DOES NOT BOOT ---
  no_boot:
    question: "Does the bootloader appear?"
    options:
      y: "Yes"
      n: "No"
    next:
      y: bootloader_issue
      n: firmware_issue

  firmware_issue:
    question: "Does firmware/UEFI detect the disk?"
    options:
      y: "Yes"
      n: "No"
    next:
      y: firmware_boot_order
      n: firmware_disk_missing

  firmware_boot_order:
    result:
      - "Check UEFI boot order."
      - "Disable Secure Boot if unsupported."
      - "Verify correct boot mode (UEFI vs BIOS)."

  firmware_disk_missing:
    result:
      - "Disk not detected by firmware."
      - "Check SATA/NVMe connections."
      - "Hardware failure or controller disabled in firmware."

  # --- BOOTLOADER ---
  bootloader_issue:
    question: "Can you select a kernel entry?"
    options:
      y: "Yes"
      n: "No"
    next:
      y: kernel_issue
      n: bootloader_missing

  bootloader_missing:
    result:
      - "Bootloader missing or misconfigured."
      - "Reinstall bootloader from live ISO using chroot."

  # --- KERNEL STAGE ---
  kernel_issue:
    question: "Does the kernel start loading?"
    options:
      y: "Yes, then fails"
      n: "No output at all"
    next:
      y: kernel_load_fail
      n: silent_kernel

  silent_kernel:
    result:
      - "Check kernel command line parameters."
      - "Remove quiet/splash options."
      - "Try fallback or LTS kernel."

  kernel_load_fail:
    question: "Are you dropped into an emergency shell?"
    options:
      y: "Yes"
      n: "No (panic or reboot)"
    next:
      y: initramfs_issue
      n: early_boot_issue

  # --- INITRAMFS ---
  initramfs_issue:
    question: "Error mentions root device or modules?"
    options:
      y: "Yes"
      n: "No"
    next:
      y: initramfs_rebuild
      n: initramfs_unknown

  initramfs_rebuild:
    result:
      - "Likely missing drivers or hooks."
      - "From chroot:"
      - "mkinitcpio -P"
      - "Verify HOOKS in mkinitcpio.conf."

  initramfs_unknown:
    result:
      - "Check cryptsetup, LVM, RAID hooks."
      - "Verify correct UUIDs in bootloader config."

  early_boot_issue:
    result:
      - "Failure before userspace."
      - "May indicate firmware, microcode, or hardware issues."
      - "Try disabling graphics modesetting."

  # --- EMERGENCY SHELL ---
  emergency_shell:
    question: "Is the root filesystem mounted read-only?"
    options:
      y: "Yes"
      n: "No"
    next:
      y: emergency_root
      n: emergency_logs

  emergency_root:
    result:
      - "Root filesystem may be corrupted."
      - "Boot from ISO and run fsck."

  emergency_logs:
    result:
      - "Inspect logs if available:"
      - "journalctl -xb"
      - "Look for mount or driver failures."

  # --- KERNEL PANIC ---
  panic:
    question: "Did this occur after a kernel update?"
    options:
      y: "Yes"
      n: "No"
    next:
      y: panic_after_update
      n: panic_other

  panic_after_update:
    question: "Is an older kernel available?"
    options:
      y: "Yes"
      n: "No"
    next:
      y: boot_old_kernel
      n: reinstall_kernel

  boot_old_kernel:
    result:
      - "Boot older or fallback kernel."
      - "Then rebuild initramfs or reinstall kernel."

  reinstall_kernel:
    result:
      - "From chroot:"
      - "pacman -S linux linux-firmware"
      - "mkinitcpio -P"

  panic_other:
    result:
      - "Kernel panic without update."
      - "Possible causes:"
      - "Hardware failure"
      - "Faulty RAM"
      - "Broken kernel parameters"

  # --- FILESYSTEM ---
  filesystem:
    question: "Is filesystem corruption suspected?"
    options:
      y: "Yes"
      n: "No"
    next:
      y: fsck_needed
      n: fs_unknown

  fsck_needed:
    result:
      - "Run fsck from live ISO."
      - "Never fsck a mounted filesystem."
      - "Backup data if possible first."

  fs_unknown:
    question: "Are there disk I/O errors?"
    options:
      y: "Yes"
      n: "No"
    next:
      y: disk_health
      n: fs_config

  disk_health:
    result:
      - "Check SMART data:"
      - "smartctl -a /dev/sdX"
      - "Disk failure may be imminent."

  fs_config:
    result:
      - "Check /etc/fstab for incorrect UUIDs."
      - "Mount failures commonly cause boot drops."
