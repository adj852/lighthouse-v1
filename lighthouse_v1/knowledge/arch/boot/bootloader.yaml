start: firmware_type

nodes:
  firmware_type:
    question: >
      Before touching bootloaders, we need to know
      what kind of firmware your system uses.

      This determines what *can* work.
    options:
      u: "UEFI (modern systems)"
      b: "Legacy BIOS"
      n: "Not sure"
    next:
      u: uefi_intro
      b: bios_intro
      n: detect_firmware

  detect_firmware:
    question: >
      Let’s check directly.

      Does the directory /sys/firmware/efi exist?
    options:
      y: "Yes"
      n: "No"
    next:
      y: uefi_intro
      n: bios_intro

  # =================================================
  # UEFI SECTION
  # =================================================

  uefi_intro:
    result:
      - description: >
          Your system uses UEFI firmware.
      - description: >
          UEFI systems boot from files stored on a special partition
          called the EFI System Partition (ESP).
      - description: >
          Bootloaders are installed as .efi files
          and registered in firmware NVRAM.
      - description: >
          This is the modern, recommended setup for Arch.

  uefi_path:
    question: >
      Which bootloader are you using
      or planning to use?
    options:
      s: "systemd-boot"
      g: "GRUB"
      o: "Not sure / something else"
    next:
      s: sdb_intro
      g: grub_intro
      o: bootloader_overview

  sdb_intro:
    question: >
      systemd-boot is simple and clean.

      Does your system meet these conditions?
    options:
      y: "Single OS, UEFI only"
      n: "Multiple OSes or unsure"
    next:
      y: sdb_details
      n: sdb_limitations

  sdb_details:
    result:
      - description: >
          systemd-boot is an excellent choice.
      - description: >
          Key requirements:
          - UEFI firmware
          - EFI System Partition (FAT32)
          - ESP mounted at /boot or /efi
      - description: >
          Kernel updates are handled automatically
          when using unified or loader entries.
      - description: >
          Minimal configuration, very reliable.

  sdb_limitations:
    result:
      - description: >
          systemd-boot does NOT support:
          - Legacy BIOS
          - Chainloading non-UEFI systems
      - description: >
          If you dual-boot Windows or other Linux distros,
          it may still work — but GRUB is often easier.

  grub_intro:
    question: >
      GRUB is powerful but more complex.

      Why are you choosing GRUB?
    options:
      m: "Multi-boot system"
      b: "BIOS compatibility"
      c: "I just want something flexible"
    next:
      m: grub_details
      b: grub_bios_note
      c: grub_details

  grub_details:
    result:
      - description: >
          GRUB supports:
          - UEFI and BIOS
          - Multiple operating systems
          - Advanced boot options
      - description: >
          Downsides:
          - More configuration
          - Requires manual regeneration after updates
      - description: >
          On UEFI systems, GRUB installs to the ESP
          and registers itself in firmware.

  grub_bios_note:
    result:
      - description: >
          GRUB is required for Legacy BIOS systems.
      - description: >
          It installs to the disk’s MBR or BIOS boot partition.
      - description: >
          systemd-boot cannot be used here.

  bootloader_overview:
    result:
      - description: >
          Common bootloader choices on Arch:
      - description: >
          - systemd-boot: simple, UEFI-only
          - GRUB: flexible, BIOS + UEFI
          - rEFInd: graphical UEFI boot manager
      - description: >
          Choose based on firmware and complexity,
          not popularity.

  # =================================================
  # BIOS SECTION
  # =================================================

  bios_intro:
    result:
      - description: >
          Your system uses Legacy BIOS firmware.
      - description: >
          BIOS systems boot from the disk’s boot sector,
          not from EFI files.
      - description: >
          systemd-boot is NOT supported here.
      - description: >
          GRUB is the recommended and supported choice.

  bios_grub_notes:
    result:
      - description: >
          GRUB on BIOS:
          - Installs to MBR or BIOS boot partition
          - Does not require an EFI System Partition
      - description: >
          Be careful when installing on multi-disk systems
          to choose the correct disk.

  # =================================================
  # COMMON BOOT PITFALLS
  # =================================================

  boot_problems_intro:
    question: >
      Are you troubleshooting a boot problem?
    options:
      y: "Yes"
      n: "No, just planning"
    next:
      y: common_boot_issues
      n: planning_advice

  common_boot_issues:
    question: >
      What kind of issue are you seeing?
    options:
      n: "System does not appear in firmware menu"
      k: "Kernel panic or initramfs error"
      u: "Bootloader disappeared after update"
    next:
      n: esp_issue
      k: initramfs_issue
      u: reinstall_bootloader

  esp_issue:
    result:
      - description: >
          If your system does not appear in the firmware menu:
      - description: >
          - Check that the ESP is mounted correctly
          - Verify the bootloader .efi file exists
          - Confirm NVRAM entry with efibootmgr
      - description: >
          Firmware updates sometimes wipe NVRAM entries.

  initramfs_issue:
    result:
      - description: >
          Kernel or initramfs errors usually mean:
          - Missing drivers
          - Incorrect hooks
          - Broken initramfs image
      - description: >
          Regenerate initramfs:
        command: "mkinitcpio -P"

  reinstall_bootloader:
    result:
      - description: >
          Bootloaders can break after updates
          or disk changes.
      - description: >
          Reinstalling the bootloader
          often fixes the issue completely.
      - description: >
          This is safe if done carefully.

  # =================================================
  # FINAL GUIDANCE
  # =================================================

  planning_advice:
    result:
      - description: >
          Boot configuration is foundational.
      - description: >
          Take your time, read output carefully,
          and avoid guessing.
      - description: >
          Once configured correctly,
          bootloaders are extremely stable.
