start: grub_context

nodes:
  grub_context:
    question: >
      GRUB is powerful, but when it breaks it can feel scary.

      What GRUB-related problem are you dealing with?
    options:
      n: "GRUB menu does not appear"
      b: "Boot error or GRUB rescue shell"
      u: "Changes not reflected after editing config"
      i: "Installing or reinstalling GRUB"
      r: "System no longer boots at all"
    next:
      n: menu_missing
      b: boot_error
      u: config_update
      i: install
      r: no_boot

  # =================================================
  # GRUB MENU NOT APPEARING
  # =================================================

  menu_missing:
    question: >
      When you power on the system, what happens?
    options:
      y: "It boots straight into Arch"
      n: "Black screen or nothing visible"
    next:
      y: hidden_menu
      n: video_issue

  hidden_menu:
    result:
      - description: >
          GRUB hides the menu by default when only one OS is detected.
      - description: >
          This is normal behavior, not a failure.
      - description: >
          To always show the menu, edit /etc/default/grub:
      - description: >
          - GRUB_TIMEOUT=3
          - GRUB_TIMEOUT_STYLE=menu
      - description: "Regenerate GRUB configuration:"
        command: "sudo grub-mkconfig -o /boot/grub/grub.cfg"
      - description: >
          Reboot to verify the menu appears.

  video_issue:
    question: >
      Does the screen turn black immediately after firmware?
    options:
      y: "Yes"
      n: "No, but nothing useful appears"
    next:
      y: video_fix
      n: firmware_output

  video_fix:
    result:
      - description: >
          This is usually a GPU modesetting issue.
      - description: >
          Try temporarily adding kernel parameters:
          - nomodeset
          - video=efifb
      - description: >
          Long-term fixes depend on GPU vendor
          (Intel, AMD, NVIDIA).
      - description: >
          See the Arch Wiki GPU-specific pages.

  firmware_output:
    result:
      - description: >
          Check firmware settings:
          - Correct display output
          - Disable fast boot
          - Disable CSM when using UEFI
      - description: >
          Firmware settings can prevent GRUB from being visible.

  # =================================================
  # BOOT ERRORS & RESCUE SHELL
  # =================================================

  boot_error:
    question: >
      What kind of error do you see?
    options:
      r: "Dropped into GRUB rescue shell"
      e: "Error message, but GRUB menu appears"
      k: "Kernel panic after selecting entry"
    next:
      r: rescue
      e: boot_error_other
      k: kernel_issue

  rescue:
    question: >
      GRUB rescue usually means it cannot find its files.

      What likely changed recently?
    options:
      c: "GRUB files deleted or corrupted"
      d: "Disk layout or UUID changed"
      m: "ESP or /boot not mounted correctly"
    next:
      c: rescue_reinstall
      d: rescue_uuid
      m: mount_issue

  rescue_reinstall:
    result:
      - description: >
          GRUB cannot load its configuration.
      - description: >
          Boot from an Arch ISO, mount your system,
          then reinstall GRUB.
      - description: >
          This fixes most rescue shell cases.

  rescue_uuid:
    result:
      - description: >
          Disk UUIDs may have changed.
      - description: >
          This can happen after:
          - Repartitioning
          - Disk cloning
          - Filesystem recreation
      - description: >
          Verify /etc/fstab and regenerate GRUB.

  mount_issue:
    result:
      - description: >
          If /boot or /efi is not mounted,
          GRUB updates go to the wrong place.
      - description: >
          Always verify mount points before running grub-install.

  boot_error_other:
    result:
      - description: >
          Read the error message carefully.
      - description: >
          GRUB error messages are usually literal.
      - description: >
          Search the exact error text â€” many issues are documented.

  kernel_issue:
    result:
      - description: >
          Kernel panic usually means:
          - Missing initramfs
          - Incorrect root= parameter
          - Broken initramfs hooks
      - description: >
          Regenerate initramfs:
        command: "mkinitcpio -P"
      - description: >
          Then regenerate GRUB config.

  # =================================================
  # CONFIG CHANGES NOT APPLYING
  # =================================================

  config_update:
    question: >
      After editing /etc/default/grub, did you regenerate grub.cfg?
    options:
      y: "Yes"
      n: "No"
    next:
      y: config_done
      n: config_regen

  config_regen:
    result:
      - description: >
          GRUB does NOT auto-update.
      - description: >
          Every config change requires regeneration:
        command: "sudo grub-mkconfig -o /boot/grub/grub.cfg"

  config_done:
    result:
      - description: >
          If changes still do not apply:
      - description: >
          - Verify which /boot is mounted
          - Ensure only one grub.cfg exists
      - description: >
          Multiple disks or ESPs often cause confusion.

  # =================================================
  # INSTALLATION / REINSTALLATION
  # =================================================

  install:
    question: >
      Which firmware does your system use?
    options:
      u: "UEFI"
      b: "Legacy BIOS"
    next:
      u: install_uefi
      b: install_bios

  install_uefi:
    result:
      - description: >
          GRUB UEFI installation checklist:
          - EFI System Partition mounted
          - Correct architecture (x86_64-efi)
          - NVRAM writable
      - description: "Install GRUB (UEFI):"
        command: "grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB"
      - description: >
          Then generate configuration:
        command: "grub-mkconfig -o /boot/grub/grub.cfg"

  install_bios:
    result:
      - description: >
          BIOS installation notes:
          - Install to the disk, not a partition
          - Choose the correct device
      - description: "Install GRUB (BIOS):"
        command: "grub-install --target=i386-pc /dev/sdX"
      - description: >
          Then generate configuration.

  # =================================================
  # COMPLETE BOOT FAILURE
  # =================================================

  no_boot:
    result:
      - description: >
          If nothing boots at all:
      - description: >
          - Use an Arch ISO
          - Mount root, boot, and ESP
          - chroot into the system
      - description: >
          From there, reinstall kernel, initramfs, and GRUB.
      - description: >
          Almost all boot failures are recoverable.
