start: nm_context

nodes:
  nm_context:
    question: >
      NetworkManager is a general-purpose network configuration daemon.
      It manages Wi-Fi, Ethernet, VPNs, and mobile broadband.
      What issue are you currently facing?
    options:
      s: "NetworkManager service not running"
      w: "Wi-Fi not connecting"
      e: "Ethernet not working"
      c: "Connection drops or is unstable"
    next:
      s: service_state
      w: wifi_issue
      e: ethernet_issue
      c: drops

  # =================================================
  # SERVICE STATE
  # =================================================

  service_state:
    question: >
      NetworkManager must be active to manage network interfaces.
      Is the NetworkManager service running?
    options:
      y: "Yes"
      n: "No"
    next:
      y: nm_conflict
      n: enable_nm

  enable_nm:
    result:
      - description: >
          Enable and start NetworkManager:
      - command: "sudo systemctl enable --now NetworkManager"
      - description: >
          After enabling, verify with:
      - command: "systemctl status NetworkManager"

  nm_conflict:
    question: >
      NetworkManager expects to be the sole manager of network interfaces.
      Are other network management services running?
    options:
      y: "Yes"
      n: "No"
    next:
      y: resolve_conflict
      n: nm_ok

  resolve_conflict:
    result:
      - description: >
          Multiple network managers will conflict.
      - description: >
          Disable or remove:
          - dhcpcd
          - netctl
          - standalone iwd instances
          - manual wpa_supplicant services
      - description: >
          Only NetworkManager should control interfaces.

  nm_ok:
    result:
      - description: >
          NetworkManager is running without obvious service conflicts.

  # =================================================
  # WI-FI ISSUES
  # =================================================

  wifi_issue:
    question: >
      Does NetworkManager detect nearby Wi-Fi networks?
    options:
      y: "Yes, networks appear"
      n: "No, nothing is listed"
    next:
      y: auth_issue
      n: wifi_backend

  wifi_backend:
    question: >
      NetworkManager uses a Wi-Fi backend to handle authentication.
      Which backend is configured?
    options:
      w: "wpa_supplicant"
      i: "iwd"
    next:
      w: wpa_ok
      i: iwd_ok

  wpa_ok:
    result:
      - description: >
          wpa_supplicant must be installed and available.
      - description: >
          NetworkManager will manage it automatically.
      - description: >
          Inspect logs with:
      - command: "journalctl -u NetworkManager"

  iwd_ok:
    result:
      - description: >
          Ensure NetworkManager is configured to use iwd:
      - description: >
          /etc/NetworkManager/NetworkManager.conf
      - description: >
          [device]
          wifi.backend=iwd
      - description: >
          Restart NetworkManager after changes.

  auth_issue:
    question: >
      Does the connection fail during authentication?
    options:
      y: "Yes"
      n: "No"
    next:
      y: auth_fix
      n: wifi_unknown

  auth_fix:
    result:
      - description: >
          Authentication failures usually involve:
          - Incorrect passphrase
          - WPA2/WPA3 mismatch
          - Router compatibility issues
      - description: >
          Check logs with:
      - command: "journalctl -u NetworkManager"

  wifi_unknown:
    result:
      - description: >
          Wi-Fi issues without authentication errors may indicate:
          - Kernel driver instability
          - Missing firmware
          - Power management problems
      - description: >
          Inspect with:
      - command: "dmesg | grep firmware"

  # =================================================
  # ETHERNET ISSUES
  # =================================================

  ethernet_issue:
    question: >
      Is the Ethernet link detected by the system?
    options:
      y: "Yes, link is detected"
      n: "No, no link"
    next:
      y: eth_ip
      n: eth_driver

  eth_ip:
    result:
      - description: >
          Verify IP address assignment:
      - command: "ip addr"
      - command: "nmcli device show"
      - description: >
          If no IP is assigned, DHCP may be failing.

  eth_driver:
    result:
      - description: >
          No Ethernet link usually indicates:
          - Unplugged or faulty cable
          - Disabled port
          - Missing or incorrect driver
      - description: >
          Check:
          - ethtool
          - lspci
          - dmesg

  # =================================================
  # CONNECTION DROPS
  # =================================================

  drops:
    question: >
      Does the connection drop intermittently or under load?
    options:
      y: "Yes"
      n: "No"
    next:
      y: drop_causes
      n: stable

  drop_causes:
    result:
      - description: >
          Common causes of unstable connections include:
          - Aggressive power saving
          - Buggy drivers
          - Poor signal quality
      - description: >
          Try disabling Wi-Fi power saving:
      - description: >
          nmcli device set wlan0 power_save off

  stable:
    result:
      - description: >
          The connection appears stable.
          No immediate NetworkManager issue detected.
