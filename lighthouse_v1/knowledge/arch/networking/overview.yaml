start: connection_state

nodes:
  connection_state:
    question: >
      Networking problems can occur at several layers:
      hardware, link, IP addressing, routing, or DNS.
      What best describes your current issue?
    options:
      n: "No network connection at all"
      l: "Connected but no internet access"
      s: "Slow or unstable connection"
      d: "DNS resolution problems"
    next:
      n: no_connection
      l: link_no_internet
      s: slow_connection
      d: dns_entry

  # =================================================
  # NO CONNECTION AT ALL
  # =================================================

  no_connection:
    question: >
      First determine whether the kernel sees any network interfaces.
      Does `ip link` list a network interface?
    options:
      y: "Yes, an interface exists"
      n: "No, nothing relevant appears"
    next:
      y: interface_up
      n: interface_missing

  interface_missing:
    question: >
      Is the missing interface Wi-Fi or Ethernet?
    options:
      y: "Wi-Fi"
      n: "Ethernet"
    next:
      y: wifi_driver
      n: ethernet_driver

  # -----------------
  # Wi-Fi hardware
  # -----------------

  wifi_driver:
    question: >
      Kernel messages often reveal missing firmware or driver failures.
      What does `dmesg` show?
    options:
      f: "Firmware missing errors"
      o: "No obvious errors"
    next:
      f: wifi_firmware
      o: wifi_unknown

  wifi_firmware:
    result:
      - description: >
          Missing firmware prevents Wi-Fi devices from initializing.
      - description: >
          Install the firmware package:
      - command: "sudo pacman -S linux-firmware"
      - description: >
          Reboot or reload the driver afterward.

  wifi_unknown:
    result:
      - description: >
          No firmware errors detected.
      - description: >
          Possible causes:
          - Unsupported chipset
          - Incorrect kernel module
          - Device blocked by rfkill
      - description: >
          Check:
          - lspci / lsusb
          - rfkill list

  # -----------------
  # Ethernet hardware
  # -----------------

  ethernet_driver:
    question: >
      Is the Ethernet controller visible to the system?
    options:
      y: "Yes (listed in lspci / lsusb)"
      n: "No"
    next:
      y: eth_detected
      n: eth_missing

  eth_detected:
    result:
      - description: >
          Hardware is detected.
      - description: >
          Verify:
          - Kernel driver is loaded
          - Cable is connected
          - Link LEDs are active

  eth_missing:
    result:
      - description: >
          Ethernet controller not detected.
      - description: >
          Possible causes:
          - Disabled in BIOS/UEFI
          - Hardware failure
          - Unsupported chipset

  # =================================================
  # INTERFACE EXISTS
  # =================================================

  interface_up:
    question: >
      Is the interface administratively UP?
    options:
      y: "Yes"
      n: "No"
    next:
      y: ip_check
      n: bring_up

  bring_up:
    result:
      - description: >
          Interfaces must be UP before they can communicate.
      - description: >
          Bring the interface up manually:
      - command: "sudo ip link set <interface> up"
      - description: >
          Or enable it via your network manager.

  # =================================================
  # IP ADDRESSING
  # =================================================

  ip_check:
    question: >
      Does the interface have an assigned IP address?
    options:
      y: "Yes"
      n: "No"
    next:
      y: internet_check
      n: dhcp_issue

  dhcp_issue:
    result:
      - description: >
          Without an IP address, networking cannot function.
      - description: >
          Common causes:
          - DHCP client not running
          - Router not responding
      - description: >
          Restart your network manager or DHCP client.

  # =================================================
  # CONNECTIVITY TESTING
  # =================================================

  internet_check:
    question: >
      Can you reach an external IP address (e.g. 1.1.1.1)?
    options:
      y: "Yes"
      n: "No"
    next:
      y: dns_entry
      n: routing_issue

  routing_issue:
    result:
      - description: >
          Failure to reach external IPs indicates a routing problem.
      - description: >
          Check:
          - Default gateway
          - Routing table
      - command: "ip route"

  # =================================================
  # LINK BUT NO INTERNET
  # =================================================

  link_no_internet:
    question: >
      Can you ping an external IP address?
    options:
      y: "Yes"
      n: "No"
    next:
      y: dns_entry
      n: routing_issue

  # =================================================
  # SLOW OR UNSTABLE CONNECTIONS
  # =================================================

  slow_connection:
    question: >
      Is this a Wi-Fi connection?
    options:
      y: "Yes"
      n: "No (wired)"
    next:
      y: wifi_quality
      n: wired_perf

  wifi_quality:
    question: >
      Is signal strength weak or fluctuating?
    options:
      y: "Yes"
      n: "No"
    next:
      y: wifi_signal
      n: wifi_driver_perf

  wifi_signal:
    result:
      - description: >
          Poor signal causes packet loss and retransmissions.
      - description: >
          Improve signal by:
          - Moving closer to the access point
          - Switching to 5 GHz or 6 GHz
          - Changing Wi-Fi channels

  wifi_driver_perf:
    result:
      - description: >
          Signal quality is adequate.
      - description: >
          Performance issues may be caused by:
          - Driver bugs
          - Power saving features
          - Firmware limitations
      - description: >
          Try disabling Wi-Fi power saving.

  wired_perf:
    result:
      - description: >
          Wired connections are usually stable.
      - description: >
          Check:
          - Link speed and duplex
          - Cable quality
          - NIC driver compatibility

  # =================================================
  # DNS ENTRY POINT
  # =================================================

  dns_entry:
    question: >
      DNS resolution issues are a common final failure point.
      Proceed to DNS-specific troubleshooting?
    options:
      y: "Yes"
    next:
      y: dns_redirect

  dns_redirect:
    result:
      - description: >
          DNS problems detected.
      - description: >
          Continue with DNS-specific diagnostics:
          resolv.conf, resolvers, and caching behavior.
