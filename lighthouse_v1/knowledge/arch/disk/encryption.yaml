start: encryption_goal
nodes:
  encryption_goal:
    question: >
      Disk encryption protects data at rest.
      Why do you want to use encryption?
    options:
      f: "Full disk encryption"
      d: "Encrypt a data or home partition"
      s: "Encrypt swap"
      n: "Learn about encryption first"
    next:
      f: full_disk
      d: data_encrypt
      s: swap_encrypt
      n: encryption_overview
  encryption_overview:
    result:
      - description: >
          Arch Linux uses dm-crypt with LUKS for disk encryption.
      - description: >
          LUKS provides:
          - Strong cryptography
          - Multiple keys
          - Metadata headers
      - description: >
          Encryption protects against offline attacks
          (stolen disks, lost laptops).
      - description: >
          It does NOT protect against a running, unlocked system.
  full_disk:
    question: "What do you want to encrypt?"
    options:
      r: "Root filesystem only"
      a: "Root + home + swap"
    next:
      r: root_only
      a: full_layout
  root_only:
    question: "Which bootloader are you using?"
    options:
      g: "GRUB"
      s: "systemd-boot"
    next:
      g: grub_encrypt
      s: sdb_encrypt
  full_layout:
    result:
      - description: >
          Common full-disk layout:
          - EFI System Partition (unencrypted)
          - Encrypted LUKS container
          - LVM or subvolumes inside
      - description: >
          This is the most secure and flexible setup.
  grub_encrypt:
    result:
      - description: >
          GRUB supports unlocking encrypted disks directly.
      - description: >
          This allows:
          - /boot inside LUKS
          - Single passphrase at boot
      - description: >
          Requirements:
          - cryptodisk enabled
          - LUKS1 or compatible LUKS2 setup
      - description: >
          GRUB encryption is complex and fragile.
  sdb_encrypt:
    result:
      - description: >
          systemd-boot cannot unlock encrypted disks.
      - description: >
          The kernel and initramfs must remain unencrypted.
      - description: >
          Decryption happens in the initramfs.
      - description: >
          This is the recommended and simplest approach.
  luks_version:
    question: "Which LUKS version do you want to use?"
    options:
      2: "LUKS2 (recommended)"
      1: "LUKS1 (legacy compatibility)"
    next:
      2: luks2
      1: luks1
  luks2:
    result:
      - description: >
          LUKS2 is the modern default.
      - description: >
          Advantages:
          - Better metadata handling
          - Argon2 key derivation
          - Flexible token support (TPM, FIDO2)
      - description: >
          Supported by systemd-based initramfs.
  luks1:
    result:
      - description: >
          LUKS1 exists mainly for GRUB compatibility.
      - description: >
          Use only if required.
      - description: >
          LUKS2 is preferred in almost all cases.
  initramfs:
    question: "Which initramfs framework do you use?"
    options:
      s: "systemd-based"
      b: "Traditional mkinitcpio"
    next:
      s: systemd_initramfs
      b: busybox_initramfs
  systemd_initramfs:
    result:
      - description: >
          Recommended for encrypted systems.
      - description: >
          Required hooks:
          - systemd
          - sd-encrypt
      - description: >
          Kernel parameters use rd.luks.*
      - description: >
          Supports TPM2 and FIDO2 unlocking.
  busybox_initramfs:
    result:
      - description: >
          Traditional setup uses the encrypt hook.
      - description: >
          Kernel parameters use cryptdevice=
      - description: >
          Simpler but less flexible than systemd-based initramfs.
  data_encrypt:
    question: "Which data do you want to encrypt?"
    options:
      h: "/home"
      d: "Separate data partition"
    next:
      h: home_encrypt
      d: data_partition
  home_encrypt:
    result:
      - description: >
          Encrypting /home protects user data.
      - description: >
          Can be unlocked:
          - At boot via crypttab
          - On login via PAM or systemd-homed
      - description: >
          Root filesystem remains unencrypted.
  data_partition:
    result:
      - description: >
          Data partitions can be encrypted independently.
      - description: >
          Useful for:
          - External drives
          - Shared storage
      - description: >
          Can be unlocked manually or automatically.
  swap_encrypt:
    question: "How do you want to encrypt swap?"
    options:
      t: "Temporary (random key)"
      p: "Persistent (LUKS)"
    next:
      t: swap_random
      p: swap_luks
  swap_random:
    result:
      - description: >
          Random-key swap is recommended.
      - description: >
          Swap is encrypted with a new key each boot.
      - description: >
          Prevents data recovery from swap.
      - description: >
          No passphrase required.
  swap_luks:
    result:
      - description: >
          LUKS-encrypted swap allows hibernation.
      - description: >
          Requires consistent key across boots.
      - description: >
          Slightly more complex configuration.
  key_management:
    question: "How do you want to unlock encrypted volumes?"
    options:
      p: "Passphrase only"
      k: "Keyfile"
      t: "TPM2"
      f: "FIDO2 / security key"
    next:
      p: passphrase
      k: keyfile
      t: tpm
      f: fido
  passphrase:
    result:
      - description: >
          Passphrases are the most portable option.
      - description: >
          Security depends on length and entropy.
      - description: >
          Recommended for laptops.
  keyfile:
    result:
      - description: >
          Keyfiles allow automatic unlocking.
      - description: >
          Must be protected:
          - Stored on encrypted root
          - Or on removable media
      - description: >
          Reduces security if stolen.
  tpm:
    result:
      - description: >
          TPM2 can unlock disks automatically.
      - description: >
          Tied to system state (PCRs).
      - description: >
          Supported by systemd-cryptenroll.
  fido:
    result:
      - description: >
          FIDO2 hardware keys provide strong security.
      - description: >
          Requires physical presence.
      - description: >
          Ideal for high-security systems.
  trim:
    question: "Are you using an SSD?"
    options:
      y: "Yes"
      n: "No"
    next:
      y: ssd_trim
      n: trim_note
  ssd_trim:
    result:
      - description: >
          TRIM can be enabled for encrypted SSDs.
      - description: >
          Use discard option with caution.
      - description: >
          Periodic fstrim is preferred for security.
  trim_note:
    result:
      - description: >
          TRIM is irrelevant for HDDs.
  luks_backup:
    result:
      - description: >
          Always back up your LUKS header.
      - description: >
          Loss of header = permanent data loss.
      - description: "Backup example:"
        command: "cryptsetup luksHeaderBackup /dev/sdX --header-backup-file luks.img"
  recovery:
    result:
      - description: >
          Common encryption failures:
          - Wrong UUID in kernel parameters
          - Missing initramfs hooks
          - Header corruption
      - description: >
          Always test unlocking from a live ISO.
