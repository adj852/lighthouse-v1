start: aur_problem

nodes:
  aur_problem:
    question: >
      Something went wrong with an AUR package — that's okay,
      it happens to everyone on Arch.

      What kind of problem are you seeing?
    options:
      b: "The package failed to build"
      d: "A dependency is missing or broken"
      u: "The package broke after an update"
      i: "I'm not sure — I just see errors"
    next:
      b: build_fail_intro
      d: dependency_intro
      u: breakage_intro
      i: unsure_intro

  # =================================================
  # BUILD FAILURES
  # =================================================

  build_fail_intro:
    question: >
      Build failures are the most common AUR issue.

      Does the error mention a missing dependency?
    options:
      y: "Yes, a dependency is missing"
      n: "No, it fails during build or compilation"
    next:
      y: dependency_intro
      n: build_stage_check

  build_stage_check:
    question: >
      At which stage does the build fail?
    options:
      s: "Source download"
      c: "Compilation / build()"
      p: "Packaging / install step"
    next:
      s: source_issue
      c: compile_issue
      p: packaging_issue

  source_issue:
    result:
      - description: >
          The source failed to download.
      - description: >
          Common reasons:
          - Upstream removed or renamed files
          - Version bump without PKGBUILD update
          - Temporary network issues
      - description: >
          What to do:
          - Check AUR comments for fixes
          - Verify source URLs manually
          - Wait for the maintainer to update the PKGBUILD
      - description: >
          This is not your fault — it happens often.

  compile_issue:
    result:
      - description: >
          Compilation errors usually indicate:
          - Incompatible library versions
          - Toolchain updates (gcc, clang, glibc)
      - description: >
          Make sure your system is fully updated:
        command: "sudo pacman -Syu"
      - description: >
          Then rebuild the package from scratch.
      - description: >
          Reading the *first* real error is often more helpful
          than scrolling to the bottom.

  packaging_issue:
    result:
      - description: >
          Packaging errors happen when files are installed
          into unexpected locations.
      - description: >
          This usually means:
          - Upstream changed install paths
          - PKGBUILD needs adjustment
      - description: >
          Check AUR comments or report the issue politely.

  # =================================================
  # DEPENDENCY PROBLEMS
  # =================================================

  dependency_intro:
    question: >
      Dependency issues are very common.

      Is the missing dependency from official repositories?
    options:
      y: "Yes, it's an official package"
      n: "No, it's another AUR package"
    next:
      y: dependency_repo
      n: dependency_aur

  dependency_repo:
    result:
      - description: >
          If an official repo dependency is missing:
      - description: >
          - Your system may be partially upgraded
          - Mirrors may be out of sync
      - description: >
          Fix by fully upgrading your system:
        command: "sudo pacman -Syu"
      - description: >
          Partial upgrades are unsupported on Arch
          and cause many AUR failures.

  dependency_aur:
    result:
      - description: >
          AUR dependencies must be built first.
      - description: >
          Most helpers handle this automatically,
          but failures still happen.
      - description: >
          Try building dependencies manually in order.
      - description: >
          Check if the dependency itself is broken
          or unmaintained.

  # =================================================
  # POST-UPDATE BREAKAGE
  # =================================================

  breakage_intro:
    question: >
      Did the package stop working after a system upgrade?
    options:
      y: "Yes"
      n: "Not sure"
    next:
      y: rebuild_packages
      n: breakage_unclear

  rebuild_packages:
    result:
      - description: >
          This is expected behavior on Arch.
      - description: >
          AUR packages are not rebuilt automatically
          when libraries change.
      - description: >
          Rebuild affected AUR packages:
        command: "yay -S --rebuildall"
      - description: >
          Or rebuild only the broken package.
      - description: >
          This fixes most post-update issues.

  breakage_unclear:
    result:
      - description: >
          If the cause is unclear:
      - description: >
          - Check journal logs
          - Try running the application from terminal
          - Look for missing shared libraries
      - description: >
          Often the error message already tells you the cause.

  # =================================================
  # UNSURE / GENERAL ERRORS
  # =================================================

  unsure_intro:
    result:
      - description: >
          When in doubt, slow down and observe.
      - description: >
          Helpful steps:
          - Read the error carefully
          - Scroll up to the first failure
          - Search the error message online
      - description: >
          AUR comments often contain the exact solution.
      - description: >
          You are not expected to know everything —
          troubleshooting is part of the Arch experience.

  # =================================================
  # FINAL REASSURANCE
  # =================================================

  aur_troubleshooting_end:
    result:
      - description: >
          AUR problems are not a sign of failure.
      - description: >
          They are part of using a rolling-release,
          user-driven ecosystem.
      - description: >
          Each issue you solve makes you more confident
          and self-sufficient on Arch.
