start: memory_goal

nodes:
  memory_goal:
    question: >
      Linux memory behavior is often misunderstood.
      What problem are you actually experiencing?
    options:
      o: "Out of memory, freezes, or apps killed"
      s: "High memory usage reported"
      t: "Tune swap behavior"
    next:
      o: oom_intro
      s: usage_intro
      t: swap_intro

  # --- OOM / FREEZES ---
  oom_intro:
    question: >
      How does the issue present itself?
    options:
      f: "System freezes or becomes unresponsive"
      k: "Applications are killed automatically"
    next:
      f: freeze_check
      k: oom_kill

  freeze_check:
    question: >
      Does the system recover after waiting?
    options:
      y: "Yes"
      n: "No"
    next:
      y: freeze_pressure
      n: hard_lock

  freeze_pressure:
    result:
      - description: >
          Temporary freezes usually indicate memory pressure.
      - description: >
          The kernel is reclaiming cache or swapping.
      - description: >
          This is common on low-RAM systems.

  hard_lock:
    result:
      - description: >
          Complete lockups may indicate:
          - No swap configured
          - Insufficient RAM
          - Kernel bugs
      - description: >
          Adding swap often prevents hard freezes.

  oom_kill:
    result:
      - description: >
          The OOM killer activates only as a last resort.
      - description: >
          It terminates processes to keep the system alive.
      - description: >
          Check logs with:
      - command: "journalctl -k | grep -i oom"

  # --- HIGH MEMORY USAGE ---
  usage_intro:
    question: >
      What does the memory usage look like?
    options:
      c: "Cache/buffers are high"
      a: "Applications consume most RAM"
    next:
      c: cache_behavior
      a: app_usage

  cache_behavior:
    result:
      - description: >
          Linux uses free RAM for disk cache.
      - description: >
          Cached memory is instantly reclaimable.
      - description: >
          High cache usage is healthy and expected.
      - description: >
          Do NOT manually drop caches.

  app_usage:
    question: >
      Is a specific application consuming excessive memory?
    options:
      y: "Yes"
      n: "No"
    next:
      y: identify_app
      n: memory_pressure_intro

  identify_app:
    result:
      - description: >
          Identify memory-heavy processes with:
      - command: "htop"
      - command: "ps aux --sort=-%mem | head"
      - description: >
          Some workloads (browsers, VMs, builds) are memory-hungry by design.

  memory_pressure_intro:
    question: >
      Is the system still responsive?
    options:
      y: "Yes"
      n: "No"
    next:
      y: normal_pressure
      n: pressure_problem

  normal_pressure:
    result:
      - description: >
          High RAM usage alone is not a problem.
      - description: >
          Linux will reclaim memory when needed.

  pressure_problem:
    result:
      - description: >
          Unresponsiveness under load suggests insufficient RAM or swap.
      - description: >
          Consider adding swap or reducing workload.

  # --- SWAP BEHAVIOR ---
  swap_intro:
    question: >
      Swap acts as a safety net, not a performance feature.
      Is swap currently configured?
    options:
      y: "Yes"
      n: "No"
    next:
      y: swap_type
      n: swap_missing

  swap_missing:
    result:
      - description: >
          Systems without swap are more prone to OOM and freezes.
      - description: >
          Even fast SSD swap is better than no swap.
      - description: >
          Recommended minimum:
          - 2–4 GB for desktops
          - More for low-RAM systems

  swap_type:
    question: >
      What type of swap are you using?
    options:
      p: "Swap partition"
      f: "Swap file"
      z: "zram"
    next:
      p: swap_partition
      f: swap_file
      z: zram

  swap_partition:
    result:
      - description: >
          Swap partitions are traditional and reliable.
      - description: >
          Performance is similar to swap files on SSDs.

  swap_file:
    result:
      - description: >
          Swap files are flexible and easy to resize.
      - description: >
          Fully supported on ext4, xfs, and btrfs (with care).

  zram:
    result:
      - description: >
          zram provides compressed RAM-based swap.
      - description: >
          Useful on low-RAM systems.
      - description: >
          Reduces I/O but increases CPU usage.

  # --- SWAPPINESS ---
  swappiness_intro:
    question: >
      Swappiness controls how aggressively the kernel uses swap.
      Do you want to adjust it?
    options:
      y: "Yes"
      n: "No"
    next:
      y: swappiness_adjust
      n: swappiness_default

  swappiness_default:
    result:
      - description: >
          Default swappiness (60) is reasonable for most systems.
      - description: >
          Avoid tuning unless you understand the tradeoffs.

  swappiness_adjust:
    question: >
      What is your system type?
    options:
      d: "Desktop / Laptop"
      s: "Server"
    next:
      d: swappiness_desktop
      s: swappiness_server

  swappiness_desktop:
    result:
      - description: >
          Lower values (10–30) reduce swap usage.
      - description: >
          Avoid setting swappiness to 0.
      - description: >
          Example:
      - command: "sysctl vm.swappiness=20"

  swappiness_server:
    result:
      - description: >
          Higher swappiness may improve memory stability.
      - description: >
          Especially useful for long-running services.

  finish_memory:
    result:
      - description: >
          Key takeaways:
          - Free RAM is wasted RAM
          - Cache is not a problem
          - Swap prevents freezes
          - OOM killer is a last resort
          - Tuning is optional, not required
